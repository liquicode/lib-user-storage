!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["lib-user-storage"]=t():e["lib-user-storage"]=t()}("undefined"!=typeof self?self:this,(()=>(()=>{"use strict";var e={339:(e,t,r)=>{const n=r(147),i=r(17);r(478);const a=r(865),o=r(828),s=r(7),l=r(585),{stringify:u}=r(477);t.NewJsonProvider=function(e={}){let t={},r=[],u="",c=!1;async function _(){return new Promise((async(e,t)=>{try{if(c){let e=u+".lock",i={stale:15e3,retries:1e3};try{s.lockSync(e,i),n.writeFileSync(u,JSON.stringify(r,null,"\t"))}catch(e){t(e)}finally{s.unlockSync(e)}}c=!1,e()}catch(e){t(e)}}))}return!l.value_missing_null_empty(e.database_name)&&!l.value_missing_null_empty(e.collection_name)&&(e.database_name=i.resolve(e.database_name),n.existsSync(e.database_name)||n.mkdirSync(e.database_name,{recursive:!0}),u=i.join(e.database_name,e.collection_name),u.toLowerCase().endsWith(".json")||(u+=".json"),e.clear_collection_on_start&&n.existsSync(u)&&n.unlinkSync(u),n.existsSync(u)&&(r=JSON.parse(n.readFileSync(u,"utf8")),Array.isArray(r)||(r=[r])),e.flush_every_ms&&e.flush_every_ms>0)&&setInterval((()=>_()),e.flush_every_ms).unref(),t.Flush=_,t.Count=async function(e){return new Promise((async(t,n)=>{try{let n=0;if(l.value_missing_null_empty(e))n=r.length;else for(let t=0;t<r.length;t++){let i=r[t];a.test(i,e)&&n++}t(n)}catch(e){n(e)}}))},t.FindOne=async function(e){return new Promise((async(t,n)=>{try{let n=null;if(l.value_missing_null_empty(e))r.length>0&&(n=l.clone(r[0]));else for(let t=0;t<r.length;t++){let i=r[t];if(a.test(i,e)){n=l.clone(i);break}}t(n)}catch(e){n(e)}}))},t.FindMany=async function(e){return new Promise((async(t,n)=>{try{let n=[];for(let t=0;t<r.length;t++){let i=r[t];(l.value_missing_null_empty(e)||a.test(i,e))&&n.push(l.clone(i))}t(n)}catch(e){n(e)}}))},t.CreateOne=async function(t){return new Promise((async(n,i)=>{try{t._id=o.v4();let i=l.clone(t);r.push(i),c=!0,e.flush_on_update&&await _(),n(l.clone(i))}catch(e){i(e)}}))},t.WriteOne=async function(t,n){return new Promise((async(i,o)=>{try{if(l.value_missing_null_empty(n)){if(l.value_missing_null_empty(t._id))throw new Error("You must supply either [Criteria] or [DataObject._id] in the parameters.");n={_id:t._id}}for(let o=0;o<r.length;o++){let s=r[o];if(a.test(s,n))return r[o]=l.merge_objects(s,t),c=!0,e.flush_on_update&&await _(),void i(1)}i(0)}catch(e){o(e)}}))},t.DeleteOne=async function(t){return new Promise((async(n,i)=>{try{let i=0;if(l.value_missing_null_empty(t))r.length>0&&(r.splice(0,1),i++);else for(let e=0;e<r.length;e++){let n=r[e];if(a.test(n,t)){r.splice(e,1),i++;break}}i>0&&(c=!0,e.flush_on_update&&await _()),n(i)}catch(e){i(e)}}))},t.DeleteMany=async function(t){return new Promise((async(n,i)=>{try{let i=0;if(l.value_missing_null_empty(t))i=r.length,r=[];else for(let e=r.length-1;e>=0;e--){let n=r[e];a.test(n,t)&&(r.splice(e,1),i++)}i>0&&(c=!0,e.flush_on_update&&await _()),n(i)}catch(e){i(e)}}))},t}},776:(e,t,r)=>{const n=r(13),i=r(585);t.NewMongoProvider=function(e){let t={};async function r(t){let r=null,i=null;try{if(i=await n.MongoClient.connect(e.connection_string,{keepAlive:!0,useUnifiedTopology:!0,useNewUrlParser:!0}),!i)throw new Error("Unable to establish a connection to the mongodb database server.");r=i.db(e.database_name);let a=r.collection(e.collection_name);return await t(a)}catch(e){throw e}finally{i&&i.close()}}return t.WithStorage=r,t.Flush=async function(){return new Promise((async(e,t)=>{e()}))},t.Count=async function(e){return await r((async function(t){return await t.countDocuments(e)}))},t.FindOne=async function(e){return await r((async function(t){return await t.findOne(e)}))},t.FindMany=async function(e){return await r((async function(t){let r=await t.find(e);if(!r)throw new Error("Unable to obtain a cursor on the collection.");return await r.toArray()}))},t.CreateOne=async function(e){return await r((async function(t){if(!(await t.insertOne(e)).acknowledged)throw new Error("Database did not acknowledge insertion.");let r=i.clone(e);return r._id=e._id,r}))},t.WriteOne=async function(e,t){return await r((async function(r){i.value_missing_null_empty(t)&&(t={_id:e._id});let n=i.clone(e);delete n._id;let a=await r.replaceOne(t,n);if(!a.acknowledged)throw new Error("Database did not acknowledge insertion.");return a.modifiedCount}))},t.DeleteOne=async function(e){return await r((async function(t){let r=await t.deleteOne(e);if(!r.acknowledged)throw new Error("Database did not acknowledge deletion.");return r.deletedCount}))},t.DeleteMany=async function(e){return await r((async function(t){let r=await t.deleteMany(e);if(!r.acknowledged)throw new Error("Database did not acknowledge deletion.");return r.deletedCount}))},t}},585:(e,t)=>{function r(e){if(null===e)return!0;switch(typeof e){case"undefined":return!0;case"string":if(0===e.length)return!0;case"object":if(null===e)return!0;if(0===Object.keys(e).length)return!0}return!1}t.value_missing_null_empty=r,t.value_missing=function(e){return null==e},t.value_exists=function(e){return!r(e)},t.MISSING_PARAMETER_ERROR=function(e){return new Error(`Required parameter is missing: ${e}`)},t.READ_ACCESS_ERROR=function(){return new Error("User does not have read access to this object or the object does not exist.")},t.WRITE_ACCESS_ERROR=function(){return new Error("User does not have write access to this object.")},t.clone=function(e){return JSON.parse(JSON.stringify(e))},t.merge_objects=function(e,t){let r=JSON.parse(JSON.stringify(e));return function e(t,r){Object.keys(r).forEach((n=>{let i=r[n];void 0===t[n]?t[n]=JSON.parse(JSON.stringify(i)):"object"==typeof i?e(t[n],i):t[n]=JSON.parse(JSON.stringify(i))}))}(r,t),r},t.zulu_timestamp=function(){return(new Date).toISOString()}},478:e=>{e.exports=require("babel-polyfill")},865:e=>{e.exports=require("json-criteria")},7:e=>{e.exports=require("lockfile")},13:e=>{e.exports=require("mongodb")},828:e=>{e.exports=require("uuid")},147:e=>{e.exports=require("fs")},17:e=>{e.exports=require("path")},477:e=>{e.exports=require("querystring")}},t={};function r(n){var i=t[n];if(void 0!==i)return i.exports;var a=t[n]={exports:{}};return e[n](a,a.exports,r),a.exports}var n={};return(()=>{var e=n;const t=r(828),i=r(585),a=r(776),o=r(339),s={DefaultConfiguration:function(){return{storage_info_member:"__",throw_permission_errors:!1,JsonProvider:{enabled:!1,collection_name:"Collection-Name",database_name:"/path/to/store/collections",clear_collection_on_start:!1,flush_on_update:!1,flush_every_ms:0},MongoProvider:{enabled:!1,collection_name:"Collection-Name",database_name:"Database-Name",connection_string:"mongodb://<username>:<password>@<server-address"}}}};e.DefaultConfiguration=s.DefaultConfiguration,s.StorageAdministrator=function(){return{name:"Storage Administrator",user_id:"admin@lib-user-storage",user_role:"admin"}},e.StorageAdministrator=s.StorageAdministrator,e.Administrator=s.StorageAdministrator,s.StorageSupervisor=function(){return{name:"Storage Supervisor",user_id:"super@lib-user-storage",user_role:"super"}},e.StorageSupervisor=s.StorageSupervisor,e.Supervisor=s.StorageSupervisor,s.NewUserStorage=function(e={}){let r={},n=s.DefaultConfiguration();n=i.merge_objects(n,e);let l=null;l=n.MongoProvider&&n.MongoProvider.enabled?a.NewMongoProvider(n.MongoProvider):n.JsonProvider&&n.JsonProvider.enabled?o.NewJsonProvider(n.JsonProvider):o.NewJsonProvider();let u=n.storage_info_member;function c(e){if(i.value_missing_null_empty(e))throw i.MISSING_PARAMETER_ERROR("User");if(i.value_missing_null_empty(e.user_id))throw i.MISSING_PARAMETER_ERROR("User.user_id");if(i.value_missing_null_empty(e.user_role))throw i.MISSING_PARAMETER_ERROR("User.user_role")}function _(e,t){c(e);let n={},a=typeof t;if("undefined"===a);else if("string"===a)n[u]={id:t};else{if("object"!==a)throw new Error(`Unknown parameter type [${a}] for [ObjectOrID]. Must be a string, object, null, or undefined.`);if(null===t);else{let e=r.GetStorageInfo(t);i.value_missing_null_empty(e.id)?n=r.GetStorageData(t):n[u]={id:e.id}}}if("admin"===e.user_role);else if("super"===e.user_role);else{n.$or=[];{let t={};t[u+".owner_id"]=e.user_id,n.$or.push(t)}{let t={};t[u+".readers"]={$in:e.user_id},n.$or.push(t)}{let t={};t[u+".writers"]={$in:e.user_id},n.$or.push(t)}{let e={};e[u+".public"]=!0,n.$or.push(e)}}return n}return r.NewStorageObject=function(e,r){if(!i.value_exists(e))throw i.MISSING_PARAMETER_ERROR("Owner");if(!i.value_exists(e.user_id))throw i.MISSING_PARAMETER_ERROR("Owner.user_id");let n=i.clone(r);return delete n[u],n[u]={id:t.v4(),created_at:i.zulu_timestamp(),updated_at:i.zulu_timestamp(),owner_id:e.user_id,readers:[],writers:[],public:!1},n},r.GetStorageData=function(e){let t=i.clone(e);return delete t[u],t},r.GetStorageInfo=function(e){let t={};return"object"==typeof e[u]&&(t=i.clone(e[u])),t},r.UserCanShare=function(e,t){return c(e),function(e){if(i.value_missing_null_empty(e))throw i.MISSING_PARAMETER_ERROR("UserObject");if(i.value_missing_null_empty(e[u]))throw i.MISSING_PARAMETER_ERROR("UserObject[ info_member ]");if(i.value_missing_null_empty(e[u].id))throw i.MISSING_PARAMETER_ERROR("UserObject[ info_member ].id");if(i.value_missing_null_empty(e[u].owner_id))throw i.MISSING_PARAMETER_ERROR("UserObject[ info_member ].owner_id");if(i.value_missing(e[u].readers))throw i.MISSING_PARAMETER_ERROR("UserObject[ info_member ].readers");if(i.value_missing(e[u].writers))throw i.MISSING_PARAMETER_ERROR("UserObject[ info_member ].writers");if(i.value_missing(e[u].public))throw i.MISSING_PARAMETER_ERROR("UserObject[ info_member ].public")}(t),"admin"===e.user_role||"super"===e.user_role||e.user_id===t[u].owner_id},r.UserCanWrite=function(e,t){return!!r.UserCanShare(e,t)||!!t[u].writers.includes(e.user_id)},r.UserCanRead=function(e,t){return!!r.UserCanWrite(e,t)||!!t[u].readers.includes(e.user_id)||!!t[u].public},r.Count=async function(e,t){try{let r=_(e,t);return await l.Count(r)}catch(e){throw e}},r.FindOne=async function(e,t){try{let r=_(e,t),n=await l.FindOne(r);return n&&delete n._id,n}catch(e){throw e}},r.FindMany=async function(e,t){try{let r=_(e,t),n=await l.FindMany(r);return n.forEach((e=>{delete e._id})),n}catch(e){throw e}},r.CreateOne=async function(e,t){try{let n=r.NewStorageObject(e,t),i=await l.CreateOne(n);return i&&delete i._id,i}catch(e){throw e}},r.WriteOne=async function(e,t,a){try{let o=_(e,t),s=await l.FindOne(o);if(!s){if(n.throw_permission_errors)throw i.READ_ACCESS_ERROR();return 0}if(!r.UserCanWrite(e,s)){if(n.throw_permission_errors)throw i.WRITE_ACCESS_ERROR();return 0}return s[u].updated_at=i.zulu_timestamp(),s=i.merge_objects(s,a),await l.WriteOne(s)}catch(e){throw e}},r.DeleteOne=async function(e,t){try{let a=_(e,t),o=await l.FindOne(a);if(!o){if(n.throw_permission_errors)throw i.READ_ACCESS_ERROR();return 0}if(!r.UserCanWrite(e,o)){if(n.throw_permission_errors)throw i.WRITE_ACCESS_ERROR();return 0}return await l.DeleteOne(_(e,o))}catch(e){throw e}},r.DeleteMany=async function(e,t){try{let n=_(e,t),i=0,a=await l.FindMany(n);for(let t=0;t<a.length;t++){let n=a[t];if(r.UserCanWrite(e,n)){if(!await l.DeleteOne(_(e,n)))throw new Error("There was an unexpected problem deleting the object.");i++}}return i}catch(e){throw e}},r.SetOwner=async function(e,t,n){try{let a=_(e,n),o=0,s=await l.FindMany(a);for(let n=0;n<s.length;n++){let a=s[n];r.UserCanShare(e,a)&&(a[u].owner_id=t,a[u].updated_at=i.zulu_timestamp(),o+=await l.WriteOne(a))}return o}catch(e){throw e}},r.SetSharing=async function(e,t,n,a,o){n=n||[],a=a||[];try{let s=_(e,t),c=0,f=await l.FindMany(s);for(let t=0;t<f.length;t++){let s=f[t];r.UserCanShare(e,s)&&(s[u].readers=n,s[u].writers=a,s[u].public=!!o,s[u].updated_at=i.zulu_timestamp(),c+=await l.WriteOne(s))}return c}catch(e){throw e}},r.Share=async function(e,t,n,a,o){try{let s=_(e,t),c=0,f=await l.FindMany(s);for(let t=0;t<f.length;t++){let s=f[t];if(r.UserCanShare(e,s)){let e=!1;if(!i.value_missing_null_empty(n)){let t=[];if("string"==typeof n)t.push(n);else{if(!Array.isArray(n))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");t=n}t.forEach((t=>{s[u].readers.includes(t)||(s[u].readers.push(t),e=!0)}))}if(!i.value_missing_null_empty(a)){let t=[];if("string"==typeof a)t.push(a);else{if(!Array.isArray(a))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");t=a}t.forEach((t=>{s[u].writers.includes(t)||(s[u].writers.push(t),e=!0)}))}!i.value_missing_null_empty(o)&&o&&(s[u].public||(s[u].public=!0,e=!0)),e&&(s[u].updated_at=i.zulu_timestamp(),c+=await l.WriteOne(s))}}return c}catch(e){throw e}},r.Unshare=async function(e,t,n,a,o){try{let s=_(e,t),c=0,f=await l.FindMany(s);for(let t=0;t<f.length;t++){let s=f[t];if(r.UserCanShare(e,s)){let e=!1;if(!i.value_missing_null_empty(n)){let t=[];if("string"==typeof n)t.push(n);else{if(!Array.isArray(Readers))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");t=n}t.forEach((t=>{let r=s[u].readers.indexOf(t);r>=0&&(s[u].readers.slice(r,1),e=!0)}))}if(!i.value_missing_null_empty(a)){let t=[];if("string"==typeof a)t.push(a);else{if(!Array.isArray(a))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");t=a}t.forEach((t=>{let r=s[u].writers.indexOf(t);r>=0&&(s[u].writers.slice(r,1),e=!0)}))}!i.value_missing_null_empty(o)&&o&&s[u].public&&(s[u].public=!1,e=!0),e&&(s[u].updated_at=i.zulu_timestamp(),c+=await l.WriteOne(s))}}return c}catch(e){throw e}},r},e.NewUserStorage=s.NewUserStorage})(),n})()));